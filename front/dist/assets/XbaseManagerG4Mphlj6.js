import"./XvueDq6FxnTE.js";import{B as e,R as a,A as l,y as t,S as o,T as i,U as s,c as r,M as n,V as d,o as u}from"./X@element-plusCEsRLdgl.js";import{f as p,a as c,b as m,c as v,d as g,e as f,g as h,h as y,i as b}from"./XfileUploadCiTTH9xU.js";import"./XindexBmDFXdea.js";import{u as w}from"./Xqiniu-jsD3ZZPLL7.js";import{C as x}from"./Xcos-js-sdk-v5B2H1ItxU.js";import{E as k,a as j}from"./Xelement-plusK_CVChsI.js";import{b as _,e as X,ah as S,o as z,P as C,Q as T,X as V,a as U,K as E,W as K,u as B,V as P,U as q}from"./X@vueDkxIAGiu.js";import"./XpiniaCIH0lQhM.js";import"./XaxiosDtE8dZ3W.js";import"./XmittCNZ6avp8.js";import"./Xvue-routerCciq6Mc4.js";import"./XnprogressCIdgZ774.js";import"./Xvue3-sfc-loaderDa78GGQm.js";import"./Xlodash-esBg5u8xPa.js";import"./X@vueuse4nPxBlH-.js";import"./X@popperjsD3lHDW-0.js";import"./X@ctrlD2oWfImC.js";import"./XdayjsBsZV2HIa.js";import"./Xasync-validatorCuo4gI4y.js";import"./Xmemoize-oneDs0C_khL.js";import"./Xnormalize-wheel-esVn5vHDCm.js";import"./X@floating-uipMauM7H8.js";import"./Xspark-md5D6_etk78.js";import"./Xexif-jsCAaicHrt.js";const A={style:{position:"absolute",bottom:"5px",left:"10px"}},I={style:{display:"flex"}},R={class:"el-upload__text",style:{height:"30px","line-height":"30px","text-align":"center",overflow:"hidden",display:"flex","flex-flow":"row nowrap","justify-content":"center"}},L=U("em",null,"点击选择文件",-1),N={class:"el-upload__tip"},J={__name:"baseManager",props:{modelValue:{type:Array,default:()=>[]},selectKey:{type:String,default:"id"}},emits:["update:modelValue"],setup(J,{emit:M}){const O=J,W=_(null);X((()=>O.modelValue),((e,a)=>{0===e.length&&W.value.clearSelection()}));const Q=M,$=_({});p().then((e=>{$.value=e.data}));const D=_([]),F=()=>{c().then((e=>{const a=Array.isArray(e.data)?e.data:[];D.value=a}))};F();const G=_(""),H=_(!1),Y=_();_(0);const Z=_([]),ee=_(1),ae=_(20),le=_(0),te=_(0),oe=_(""),ie=_(""),se=_([]),re=_([]),ne=(e=!1)=>{e&&(ee.value=1,ae.value=20);let a={};te.value&&(a.group_id=te.value),oe.value&&(a.name=oe.value),ie.value&&(a.tag=ie.value),m(ee.value,ae.value,a).then((e=>{se.value=e.data.list,ee.value=e.data.page,ae.value=e.data.page_size,le.value=e.data.total}))},de=()=>{G.value?v(G.value,te.value).then((e=>{F(),G.value=""})):k.warning("请输入分组名称")},ue=()=>{te.value?g(te.value).then((e=>{F()})):k.warning("请选择分组")},pe=async e=>{let a=await f(e.file.name);switch(a.data.driver){case"cos":let l=JSON.parse(a.data.token);const{Credentials:t={},StartTime:o,ExpiredTime:i,bucket:s,region:r,key:n}=l;new x({SecretId:t.TmpSecretId,SecretKey:t.TmpSecretKey,SecurityToken:t.Token,StartTime:o,ExpiredTime:i}).putObject({Bucket:s,Region:r,Key:n,Body:e.file,onProgress:a=>{e.onProgress(a.percent)}},((a,l)=>{a?e.onError(error):(e.onSuccess(l),l.driver="cos",h({path:l.Location,driver:"cos",group:te.value?te.value:0,key:n})),setTimeout((()=>{te.value=0,ne(!0)}),1500)}));break;case"qiniu":w(e.file,a.data.key,a.data.token).subscribe((a=>{e.onProgress(a.total)}),(a=>{e.onError(a),setTimeout((()=>{te.value=0,ne(!0)}),1500)}),(a=>{h({path:a.cdn+a.key,driver:"qiniu",group:te.value?te.value:0,key:a.key}),e.onSuccess(a),setTimeout((()=>{te.value=0,ne(!0)}),1500)}))}},ce=()=>{Y.value.submit()},me=(e,a)=>{a.findIndex((a=>a.name==e.name))!=a.findLastIndex((a=>a.name==e.name))&&(k.info(e.name+" 已存在于列表中"),a.pop()),Z.value=a},ve=e=>{re.value=e.map((e=>e[O.selectKey])),Q("update:modelValue",re.value)},ge=e=>{ae.value=e,ne()},fe=e=>{ee.value=e,ne()},he=e=>{e.id?te.value=e.id:te.value="",ne(!0)},ye=e=>{y(re.value,e.id).then((e=>{0!=e.code?k.error(e.msg):k.success("移动成功"),ne()}))},be=async e=>{switch(e){case"clearSelected":W.value.clearSelection();break;case"downlaod":se.value.forEach((async e=>{if(re.value.includes(e.id)){const a=document.createElement("iframe");a.style.display="none",a.src=e.url+"?attname=",document.body.appendChild(a),setTimeout((()=>{document.body.removeChild(a)}),5e3)}}));break;case"copyUrl":try{let e="";se.value.forEach((a=>{re.value.includes(a.id)&&(e+=a.url+"\n")})),await navigator.clipboard.writeText(e),k({message:"已复制",type:"success"})}catch(a){k({message:"未授权读取剪贴板",type:"error"})}break;case"delete":j.confirm("删除后文件无法找回！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{b(re.value).then((e=>{0==e.code&&k({message:"已删除",type:"success"}),ne()}))}))}};return ne(),(p,c)=>{const m=S("el-tree"),v=S("el-button"),g=S("el-input"),f=S("el-popover"),h=S("el-col"),y=S("el-dropdown-item"),b=S("el-dropdown-menu"),w=S("el-dropdown"),x=S("upload-filled"),k=S("el-icon"),j=S("el-upload"),_=S("el-row"),X=S("el-table-column"),M=S("el-image"),O=S("el-table"),Q=S("el-pagination");return z(),C(_,{gutter:20,style:{width:"100%",height:"100%","box-sizing":"border-box"}},{default:T((()=>[V(h,{span:4,style:{position:"relative",height:"100%"}},{default:T((()=>[V(m,{class:"file-tree-box",data:D.value,props:{label:"name",children:"children"},onNodeClick:he,"default-expand-all":"","expand-on-click-node":!1,draggable:""},{default:T((({node:e,data:a})=>[U("div",{class:E(a.id==te.value?"self-node node-active":"self-node")},K(e.label),3)])),_:1},8,["data"]),U("div",A,[V(f,{placement:"top-start",width:260,trigger:"hover"},{reference:T((()=>[V(v,{icon:B(e),size:"small",style:{"border-right":"0px"},link:""},null,8,["icon"])])),default:T((()=>[V(g,{modelValue:G.value,"onUpdate:modelValue":c[0]||(c[0]=e=>G.value=e),style:{width:"200px"},size:"small",placeholder:"输入分组名称"},null,8,["modelValue"]),V(v,{icon:B(a),type:"success",style:{"margin-left":"10px"},onClick:de,link:""},null,8,["icon"])])),_:1}),V(v,{icon:B(l),size:"small",onClick:ue,link:""},null,8,["icon"])])])),_:1}),V(h,{span:20,style:{position:"relative",height:"100%","background-color":"#fff","box-sizing":"border-box",padding:"10px"}},{default:T((()=>[V(_,{style:{display:"flex","justify-content":"space-between"}},{default:T((()=>[U("div",I,[V(v,{icon:B(t),onClick:c[1]||(c[1]=e=>ne(!0)),style:{"margin-right":"10px"}},null,8,["icon"]),V(w,{disabled:!re.value.length,style:{"margin-right":"10px"},onCommand:be},{dropdown:T((()=>[V(b,null,{default:T((()=>[V(y,{command:"clearSelected"},{default:T((()=>[P("清空已选")])),_:1}),V(y,{command:"downlaod",icon:B(o)},{default:T((()=>[P("下载文件")])),_:1},8,["icon"]),V(y,{command:"copyUrl",icon:B(i)},{default:T((()=>[P("复制链接")])),_:1},8,["icon"]),V(y,{command:"move",icon:B(s)},{default:T((()=>[V(f,{placement:"right",width:300,trigger:"hover"},{reference:T((()=>[P(" 移动到 ")])),default:T((()=>[V(m,{data:D.value,props:{label:"name",children:"children"},onNodeClick:ye,"default-expand-all":"","expand-on-click-node":!1,draggable:""},{default:T((({node:e,data:a})=>[P(K(e.label),1)])),_:1},8,["data"])])),_:1})])),_:1},8,["icon"]),V(y,{command:"delete",icon:B(r),divided:""},{default:T((()=>[P("删除")])),_:1},8,["icon"])])),_:1})])),default:T((()=>[V(v,{disabled:!re.value.length},{default:T((()=>[P(" 批量操作"+K(re.value.length?"("+re.value.length+")":""),1)])),_:1},8,["disabled"])])),_:1},8,["disabled"]),V(g,{modelValue:oe.value,"onUpdate:modelValue":c[3]||(c[3]=e=>oe.value=e),style:{"max-width":"450px","min-width":"100px"},placeholder:"搜索文件名",clearable:"",class:"input-with-select",onClear:c[4]||(c[4]=e=>ne(!0))},{append:T((()=>[V(v,{icon:B(n),onClick:c[2]||(c[2]=e=>ne(!0))},null,8,["icon"])])),_:1},8,["modelValue"])]),V(f,{placement:"bottom-start",width:400,height:200,visible:H.value},{reference:T((()=>[V(v,{type:H.value?"danger":"primary",icon:H.value?B(r):B(d),onClick:c[5]||(c[5]=e=>H.value=!H.value)},{default:T((()=>[P(K(H.value?"关闭窗口":"上传文件"),1)])),_:1},8,["type","icon"])])),default:T((()=>[V(j,{class:"upload-demo",drag:"","auto-upload":!1,ref_key:"fileUploadRef",ref:Y,"http-request":pe,"file-list":Z.value,"onUpdate:fileList":c[6]||(c[6]=e=>Z.value=e),"on-change":me,multiple:""},{trigger:T((()=>[U("div",R,[V(k,{class:"el-icon--upload",style:{"font-size":"25px",margin:"0px var(--global-padding) 0 0"}},{default:T((()=>[V(x)])),_:1}),P(" 将文件拖到此处或"),L])])),tip:T((()=>[U("div",N,[Z.value.length?(z(),C(v,{key:0,type:"success",size:"small",icon:B(u),onClick:ce},{default:T((()=>[P(" 开始上传 ")])),_:1},8,["icon"])):q("",!0)])])),_:1},8,["file-list"])])),_:1},8,["visible"])])),_:1}),V(O,{ref_key:"tableRef",ref:W,data:se.value,"row-key":e=>e[J.selectKey],"highlight-current-row":"","show-overflow-tooltip":"",stripe:"",width:"100%",border:"",style:{"margin-top":"9px","border-top":"1px solid var(--el-table-border-color)",overflow:"auto",height:"calc(100% - 80px)"},onSelectionChange:ve},{default:T((()=>[V(X,{type:"selection","reserve-selection":!0,width:"55",fixed:""}),V(X,{prop:"name",label:"文件名",width:"350",fixed:""}),V(X,{prop:"url",label:"预览",width:"80"},{default:T((e=>{return[(a=e.row.url,/\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(a)?(z(),C(M,{key:0,style:{width:"50px",height:"50px"},src:e.row.url.startsWith("http")?e.row.url:"//"+e.row.url,lazy:"",fit:"scale-down"},null,8,["src"])):q("",!0))];var a})),_:1}),V(X,{prop:"url",label:"链接",width:"80"}),V(X,{prop:"tag",label:"类型",width:"80"}),V(X,{prop:"group_info.name",label:"分组"}),V(X,{prop:"ct",label:"创建时间",width:"160"})])),_:1},8,["data","row-key"]),V(Q,{"current-page":ee.value,"onUpdate:currentPage":c[7]||(c[7]=e=>ee.value=e),"page-size":ae.value,"onUpdate:pageSize":c[8]||(c[8]=e=>ae.value=e),"page-sizes":[20,50,100,200],size:"small",layout:"total, sizes, prev, pager, next, jumper",total:le.value,onSizeChange:ge,onCurrentChange:fe},null,8,["current-page","page-size","total"])])),_:1})])),_:1})}}};export{J as default};
