import"./XvueDq6FxnTE.js";import{B as e,R as a,A as l,y as t,S as o,T as i,U as n,c as s,M as r,V as d,o as u}from"./X@element-plusCEsRLdgl.js";import{f as c,a as p,b as m,c as v,d as f,e as g,g as h,h as y,i as b}from"./XfileUploadH4dljpzg.js";import"./XindexDNKRow1g.js";import{u as x}from"./Xqiniu-jsD3ZZPLL7.js";import{C as w}from"./Xcos-js-sdk-v5B2H1ItxU.js";import{E as k,a as j}from"./Xelement-plusK_CVChsI.js";import{b as _,e as X,ah as S,o as C,P as z,Q as T,X as V,a as U,K as E,W as K,u as B,V as P,U as q}from"./X@vueDkxIAGiu.js";import"./XpiniaCIH0lQhM.js";import"./XaxiosDtE8dZ3W.js";import"./XmittCNZ6avp8.js";import"./Xvue-routerCciq6Mc4.js";import"./XnprogressCIdgZ774.js";import"./Xvue3-sfc-loaderDa78GGQm.js";import"./Xlodash-esBg5u8xPa.js";import"./X@vueuse4nPxBlH-.js";import"./X@popperjsD3lHDW-0.js";import"./X@ctrlD2oWfImC.js";import"./XdayjsBsZV2HIa.js";import"./Xasync-validatorCuo4gI4y.js";import"./Xmemoize-oneDs0C_khL.js";import"./Xnormalize-wheel-esVn5vHDCm.js";import"./X@floating-uipMauM7H8.js";import"./Xspark-md5D6_etk78.js";import"./Xexif-jsCAaicHrt.js";const A={style:{position:"absolute",bottom:"5px",left:"10px"}},I={style:{display:"flex"}},R={class:"el-upload__text",style:{height:"30px","line-height":"30px","text-align":"center",overflow:"hidden",display:"flex","flex-flow":"row nowrap","justify-content":"center"}},L=U("em",null,"点击选择文件",-1),N={class:"el-upload__tip"},J={__name:"baseManager",props:{modelValue:{type:Array,default:()=>[]},selectKey:{type:String,default:"id"}},emits:["update:modelValue"],setup(J,{emit:M}){const O=J,Q=_(null);X((()=>O.modelValue),((e,a)=>{0===e.length&&Q.value.clearSelection()}));const W=M,D=_({});c().then((e=>{D.value=e.data}));const F=_([]),G=()=>{p().then((e=>{const a=Array.isArray(e.data)?e.data:[];F.value=a}))};G();const H=_(""),Y=_(!1),Z=_();_(0);const $=_([]),ee=_(1),ae=_(20),le=_(0),te=_(0),oe=_(""),ie=_(""),ne=_([]),se=_([]),re=(e=!1)=>{e&&(ee.value=1,ae.value=20);let a={};te.value&&(a.group_id=te.value),oe.value&&(a.name=oe.value),ie.value&&(a.tag=ie.value),m(ee.value,ae.value,a).then((e=>{ne.value=e.data.list,ee.value=e.data.page,ae.value=e.data.page_size,le.value=e.data.total}))},de=()=>{H.value?v(H.value,te.value).then((e=>{G(),H.value=""})):k.warning("请输入分组名称")},ue=()=>{te.value?f(te.value).then((e=>{G()})):k.warning("请选择分组")},ce=async e=>{let a=await g(e.file.name);switch(a.data.driver){case"cos":let l=JSON.parse(a.data.token);const{Credentials:t={},StartTime:o,ExpiredTime:i,bucket:n,region:s,key:r}=l;new w({SecretId:t.TmpSecretId,SecretKey:t.TmpSecretKey,SecurityToken:t.Token,StartTime:o,ExpiredTime:i}).putObject({Bucket:n,Region:s,Key:r,Body:e.file,onProgress:a=>{e.onProgress(a.percent)}},((a,l)=>{a?e.onError(error):(e.onSuccess(l),l.driver="cos",h({path:l.Location,driver:"cos",group:te.value?te.value:0,key:r})),setTimeout((()=>{te.value=0,re(!0)}),1500)}));break;case"qiniu":x(e.file,a.data.key,a.data.token).subscribe((a=>{e.onProgress(a.total)}),(a=>{e.onError(a),setTimeout((()=>{te.value=0,re(!0)}),1500)}),(a=>{h({path:a.cdn+a.key,driver:"qiniu",group:te.value?te.value:0,key:a.key}),e.onSuccess(a),setTimeout((()=>{te.value=0,re(!0)}),1500)}))}},pe=()=>{Z.value.submit()},me=(e,a)=>{a.findIndex((a=>a.name==e.name))!=a.findLastIndex((a=>a.name==e.name))&&(k.info(e.name+" 已存在于列表中"),a.pop()),$.value=a},ve=e=>{se.value=e.map((e=>e[O.selectKey])),W("update:modelValue",se.value)},fe=e=>{ae.value=e,re()},ge=e=>{ee.value=e,re()},he=e=>{e.id?te.value=e.id:te.value="",re(!0)},ye=e=>{y(se.value,e.id).then((e=>{0!=e.code?k.error(e.msg):k.success("移动成功"),re()}))},be=async e=>{switch(e){case"clearSelected":Q.value.clearSelection();break;case"downlaod":ne.value.forEach((async e=>{if(se.value.includes(e.id)){const a=document.createElement("iframe");a.style.display="none",a.src=e.url+"?attname=",document.body.appendChild(a),setTimeout((()=>{document.body.removeChild(a)}),5e3)}}));break;case"copyUrl":try{let e="";ne.value.forEach((a=>{se.value.includes(a.id)&&(e+=a.url+"\n")})),await navigator.clipboard.writeText(e),k({message:"已复制",type:"success"})}catch(a){k({message:"未授权读取剪贴板",type:"error"})}break;case"delete":j.confirm("删除后文件无法找回！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{b(se.value).then((e=>{0==e.code&&k({message:"已删除",type:"success"}),re()}))}))}};return re(),(c,p)=>{const m=S("el-tree"),v=S("el-button"),f=S("el-input"),g=S("el-popover"),h=S("el-col"),y=S("el-dropdown-item"),b=S("el-dropdown-menu"),x=S("el-dropdown"),w=S("upload-filled"),k=S("el-icon"),j=S("el-upload"),_=S("el-row"),X=S("el-table-column"),M=S("el-table"),O=S("el-pagination");return C(),z(_,{gutter:20,style:{width:"100%",height:"100%","box-sizing":"border-box"}},{default:T((()=>[V(h,{span:4,style:{position:"relative",height:"100%"}},{default:T((()=>[V(m,{class:"file-tree-box",data:F.value,props:{label:"name",children:"children"},onNodeClick:he,"default-expand-all":"","expand-on-click-node":!1,draggable:""},{default:T((({node:e,data:a})=>[U("div",{class:E(a.id==te.value?"self-node node-active":"self-node")},K(e.label),3)])),_:1},8,["data"]),U("div",A,[V(g,{placement:"top-start",width:260,trigger:"hover"},{reference:T((()=>[V(v,{icon:B(e),size:"small",style:{"border-right":"0px"},link:""},null,8,["icon"])])),default:T((()=>[V(f,{modelValue:H.value,"onUpdate:modelValue":p[0]||(p[0]=e=>H.value=e),style:{width:"200px"},size:"small",placeholder:"输入分组名称"},null,8,["modelValue"]),V(v,{icon:B(a),type:"success",style:{"margin-left":"10px"},onClick:de,link:""},null,8,["icon"])])),_:1}),V(v,{icon:B(l),size:"small",onClick:ue,link:""},null,8,["icon"])])])),_:1}),V(h,{span:20,style:{position:"relative",height:"100%","background-color":"#fff","box-sizing":"border-box",padding:"10px"}},{default:T((()=>[V(_,{style:{display:"flex","justify-content":"space-between"}},{default:T((()=>[U("div",I,[V(v,{icon:B(t),onClick:p[1]||(p[1]=e=>re(!0)),style:{"margin-right":"10px"}},null,8,["icon"]),V(x,{disabled:!se.value.length,style:{"margin-right":"10px"},onCommand:be},{dropdown:T((()=>[V(b,null,{default:T((()=>[V(y,{command:"clearSelected"},{default:T((()=>[P("清空已选")])),_:1}),V(y,{command:"downlaod",icon:B(o)},{default:T((()=>[P("下载文件")])),_:1},8,["icon"]),V(y,{command:"copyUrl",icon:B(i)},{default:T((()=>[P("复制链接")])),_:1},8,["icon"]),V(y,{command:"move",icon:B(n)},{default:T((()=>[V(g,{placement:"right",width:300,trigger:"hover"},{reference:T((()=>[P(" 移动到 ")])),default:T((()=>[V(m,{data:F.value,props:{label:"name",children:"children"},onNodeClick:ye,"default-expand-all":"","expand-on-click-node":!1,draggable:""},{default:T((({node:e,data:a})=>[P(K(e.label),1)])),_:1},8,["data"])])),_:1})])),_:1},8,["icon"]),V(y,{command:"delete",icon:B(s),divided:""},{default:T((()=>[P("删除")])),_:1},8,["icon"])])),_:1})])),default:T((()=>[V(v,{disabled:!se.value.length},{default:T((()=>[P(" 批量操作"+K(se.value.length?"("+se.value.length+")":""),1)])),_:1},8,["disabled"])])),_:1},8,["disabled"]),V(f,{modelValue:oe.value,"onUpdate:modelValue":p[3]||(p[3]=e=>oe.value=e),style:{"max-width":"450px","min-width":"100px"},placeholder:"搜索文件名",clearable:"",class:"input-with-select",onClear:p[4]||(p[4]=e=>re(!0))},{append:T((()=>[V(v,{icon:B(r),onClick:p[2]||(p[2]=e=>re(!0))},null,8,["icon"])])),_:1},8,["modelValue"])]),V(g,{placement:"bottom-start",width:400,height:200,visible:Y.value},{reference:T((()=>[V(v,{type:Y.value?"danger":"primary",icon:Y.value?B(s):B(d),onClick:p[5]||(p[5]=e=>Y.value=!Y.value)},{default:T((()=>[P(K(Y.value?"关闭窗口":"上传文件"),1)])),_:1},8,["type","icon"])])),default:T((()=>[V(j,{class:"upload-demo",drag:"","auto-upload":!1,ref_key:"fileUploadRef",ref:Z,"http-request":ce,"file-list":$.value,"onUpdate:fileList":p[6]||(p[6]=e=>$.value=e),"on-change":me,multiple:""},{trigger:T((()=>[U("div",R,[V(k,{class:"el-icon--upload",style:{"font-size":"25px",margin:"0px var(--global-padding) 0 0"}},{default:T((()=>[V(w)])),_:1}),P(" 将文件拖到此处或"),L])])),tip:T((()=>[U("div",N,[$.value.length?(C(),z(v,{key:0,type:"success",size:"small",icon:B(u),onClick:pe},{default:T((()=>[P(" 开始上传 ")])),_:1},8,["icon"])):q("",!0)])])),_:1},8,["file-list"])])),_:1},8,["visible"])])),_:1}),V(M,{ref_key:"tableRef",ref:Q,data:ne.value,"row-key":e=>e[J.selectKey],"highlight-current-row":"","show-overflow-tooltip":"",stripe:"",width:"100%",border:"",style:{"margin-top":"9px","border-top":"1px solid var(--el-table-border-color)",overflow:"auto",height:"calc(100% - 80px)"},onSelectionChange:ve},{default:T((()=>[V(X,{type:"selection","reserve-selection":!0,width:"55",fixed:""}),V(X,{prop:"name",label:"文件名",width:"350",fixed:""}),V(X,{prop:"url",label:"链接",width:"80"}),V(X,{prop:"tag",label:"类型",width:"80"}),V(X,{prop:"group_info.name",label:"分组"}),V(X,{prop:"ct",label:"创建时间",width:"160"})])),_:1},8,["data","row-key"]),V(O,{"current-page":ee.value,"onUpdate:currentPage":p[7]||(p[7]=e=>ee.value=e),"page-size":ae.value,"onUpdate:pageSize":p[8]||(p[8]=e=>ae.value=e),"page-sizes":[20,50,100,200],size:"small",layout:"total, sizes, prev, pager, next, jumper",total:le.value,onSizeChange:fe,onCurrentChange:ge},null,8,["current-page","page-size","total"])])),_:1})])),_:1})}}};export{J as default};
