import{S as t}from"./Xspark-md5LXhfRQWH.js";import"./Xexif-jsCywF333L.js";function e(t){var e,n,r,o,i,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,a=0,c="",h=[];if(!t)return t;t=function(t){if(null==t)return"";var e,n,r,o=t+"",i="";e=n=0,r=o.length;for(var s=0;s<r;s++){var u=o.charCodeAt(s),a=null;if(u<128)n++;else if(u>127&&u<2048)a=String.fromCharCode(u>>6|192,63&u|128);else if((63488&u^55296)>0)a=String.fromCharCode(u>>12|224,u>>6&63|128,63&u|128);else{if((64512&u^55296)>0)throw new RangeError("Unmatched trail surrogate at "+s);var c=o.charCodeAt(++s);if((64512&c^56320)>0)throw new RangeError("Unmatched lead surrogate at "+(s-1));u=((1023&u)<<10)+(1023&c)+65536,a=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,63&u|128)}null!==a&&(n>e&&(i+=o.slice(e,n)),i+=a,e=n=s+1)}return n>e&&(i+=o.slice(e,r)),i}(t+"");do{e=(i=t.charCodeAt(u++)<<16|t.charCodeAt(u++)<<8|t.charCodeAt(u++))>>18&63,n=i>>12&63,r=i>>6&63,o=63&i,h[a++]=s.charAt(e)+s.charAt(n)+s.charAt(r)+s.charAt(o)}while(u<t.length);switch(c=h.join(""),t.length%3){case 1:c=c.slice(0,-2)+"==";break;case 2:c=c.slice(0,-1)+"="}return c}function n(t){return(t=e(t)).replace(/\//g,"_").replace(/\+/g,"-")}function r(t){return function(t){var e,n,r,o,i,s,u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=0,c=0,h=[];if(!t)return t;t+="";do{e=(s=u.indexOf(t.charAt(a++))<<18|u.indexOf(t.charAt(a++))<<12|(o=u.indexOf(t.charAt(a++)))<<6|(i=u.indexOf(t.charAt(a++))))>>16&255,n=s>>8&255,r=255&s,h[c++]=64===o?String.fromCharCode(e):64===i?String.fromCharCode(e,n):String.fromCharCode(e,n,r)}while(a<t.length);return h.join("")}(t=t.replace(/_/g,"/").replace(/-/g,"+"))}var o=function(){return o=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},o.apply(this,arguments)},i=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{a(r.next(t))}catch(e){i(e)}}function u(t){try{a(r.throw(t))}catch(e){i(e)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))},s=function(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(u){i=[6,u],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},u=Math.pow(1024,2);function a(t){try{localStorage.removeItem(t)}catch(e){window.console&&window.console.warn}}function c(t){return{Authorization:"UpToken "+t}}function h(t){var e=c(t);return o({"content-type":"application/octet-stream"},e)}function l(t){var e=c(t);return o({"content-type":"application/json"},e)}function p(){return window.XMLHttpRequest?new XMLHttpRequest:window.ActiveXObject("Microsoft.XMLHTTP")}function f(e){return i(this,void 0,void 0,(function(){var n,r;return s(this,(function(o){switch(o.label){case 0:return[4,d(e)];case 1:return n=o.sent(),(r=new t.ArrayBuffer).append(n),[2,r.end()]}}))}))}function d(t){return new Promise((function(e,n){var r=new FileReader;r.onload=function(t){if(t.target){var r=t.target.result;e(r)}else n(new Error("progress event target is undefined"))},r.onerror=function(){n(new Error("fileReader read failed"))},r.readAsArrayBuffer(t)}))}function y(t,e){return new Promise((function(n,r){var o=p();if(o.open(e.method,t),e.onCreate&&e.onCreate(o),e.headers){var i=e.headers;Object.keys(i).forEach((function(t){o.setRequestHeader(t,i[t])}))}o.upload.addEventListener("progress",(function(t){t.lengthComputable&&e.onProgress&&e.onProgress({loaded:t.loaded,total:t.total})})),o.onreadystatechange=function(){var t=o.responseText;if(4===o.readyState){var e=o.getResponseHeader("x-reqId")||"";if(200!==o.status){var i="xhr request failed, code: "+o.status;return t&&(i+=" response: "+t),void r({code:o.status,message:i,reqId:e,isRequestError:!0})}try{n({data:JSON.parse(t),reqId:e})}catch(s){r(s)}}},o.send(e.body)}))}function g(t){if(t&&t.match){var e=t.match(/(^https?)/);if(!e)return"";var n=e[1];return(e=t.match(/^https?:\/\/([^:^/]*):(\d*)/))?e[2]:"http"===n?"80":"443"}return""}function b(t){if(t&&t.match){var e=t.match(/^https?:\/\/([^:^/]*)/);return e?e[1]:""}return""}function m(t){var e=t.split(":");return{ak:e.length>3?e[1]:e[0],bucket:JSON.parse(r(e[e.length-1])).scope.split(":")[0]}}var v,w=function(){function t(){}return t.prototype.log=function(t,e){var n=Object.values(t).join(",");this.send(n,e,0)},t.prototype.send=function(t,e,n){var r=this,o=p();o.open("POST","https://uplog.qbox.me/log/3"),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.setRequestHeader("Authorization","UpToken "+e),o.onreadystatechange=function(){4===o.readyState&&200!==o.status&&++n<=3&&r.send(t,e,n)},o.send(t)},t}(),k=function(){function t(t,e){this.runTask=t,this.limit=e,this.queue=[],this.processing=[]}return t.prototype.enqueue=function(t){var e=this;return new Promise((function(n,r){e.queue.push({task:t,resolve:n,reject:r}),e.check()}))},t.prototype.run=function(t){var e=this;this.queue=this.queue.filter((function(e){return e!==t})),this.processing.push(t),this.runTask(t.task).then((function(){e.processing=e.processing.filter((function(e){return e!==t})),t.resolve(),e.check()}),(function(e){return t.reject(e)}))},t.prototype.check=function(){var t=this,e=this.processing.length,n=this.limit-e;this.queue.slice(0,n).forEach((function(e){t.run(e)}))},t}(),x="z1",P="z2",E="na0",S="as0",O=((v={})["z0"]={srcUphost:"up.qiniup.com",cdnUphost:"upload.qiniup.com"},v[x]={srcUphost:"up-z1.qiniup.com",cdnUphost:"upload-z1.qiniup.com"},v[P]={srcUphost:"up-z2.qiniup.com",cdnUphost:"upload-z2.qiniup.com"},v[E]={srcUphost:"up-na0.qiniup.com",cdnUphost:"upload-na0.qiniup.com"},v[S]={srcUphost:"up-as0.qiniup.com",cdnUphost:"upload-as0.qiniup.com"},v),q=function(){return q=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},q.apply(this,arguments)},C=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{a(r.next(t))}catch(e){i(e)}}function u(t){try{a(r.throw(t))}catch(e){i(e)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))},_=function(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(u){i=[6,u],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}};function z(t,e){return C(this,void 0,void 0,(function(){var n;return _(this,(function(r){return n=m(t),[2,y(e+"//api.qiniu.com/v2/query?ak="+n.ak+"&bucket="+n.bucket,{method:"GET"})]}))}))}function j(t,e){return C(this,void 0,void 0,(function(){var n,r,o,i,s;return _(this,(function(u){switch(u.label){case 0:return n=t.upprotocol,t.uphost?[2,n+"//"+t.uphost]:t.region?(r=O[t.region],o=t.useCdnDomain?r.cdnUphost:r.srcUphost,[2,n+"//"+o]):[4,z(e,n)];case 1:return i=u.sent(),s=i.data.up.acc.main,[2,n+"//"+s[0]]}}))}))}function I(t,e,r){var o=r.url,i=r.id;return o+"/buckets/"+t+"/objects/"+(null!=e?n(e):"~")+"/uploads/"+i}function U(t,e,n,r,o){return y(I(m(t).bucket,e,r)+"/"+n,q(q({},o),{method:"PUT",headers:h(t)}))}var L=function(){return L=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},L.apply(this,arguments)},A=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{a(r.next(t))}catch(e){i(e)}}function u(t){try{a(r.throw(t))}catch(e){i(e)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))},R=function(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(u){i=[6,u],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},T=Math.pow(1024,3),D=function(){function t(t,e,n){this.statisticsLogger=n,this.xhrList=[],this.aborted=!1,this.retryCount=0,this.config=L({useCdnDomain:!0,disableStatisticsReport:!1,retryCount:3,checkByMD5:!1,uphost:"",upprotocol:"https:",forceDirect:!1,chunkSize:4,concurrentRequestLimit:3},t.config),this.putExtra=L({fname:""},t.putExtra),this.file=t.file,this.key=t.key,this.token=t.token,this.onData=e.onData,this.onError=e.onError,this.onComplete=e.onComplete;try{this.bucket=m(this.token).bucket}catch(r){this.onError(r)}}return t.prototype.putFile=function(){return A(this,void 0,void 0,(function(){var t,e,n,r,o,i,s,u;return R(this,(function(a){switch(a.label){case 0:if(this.aborted=!1,this.putExtra.fname||(this.putExtra.fname=this.file.name),this.file.size>1e4*T)throw t=new Error("file size exceed maximum value 10000G"),this.onError(t),t;if(this.putExtra.customVars&&(c=this.putExtra.customVars,!Object.keys(c).every((function(t){return 0===t.indexOf("x:")}))))throw t=new Error("customVars key should start width x:"),this.onError(t),t;if(this.putExtra.metadata&&!function(t){return Object.keys(t).every((function(t){return 0===t.indexOf("x-qn-meta-")}))}(this.putExtra.metadata))throw t=new Error("metadata key should start with x-qn-meta-"),this.onError(t),t;a.label=1;case 1:return a.trys.push([1,4,,5]),e=this,[4,j(this.config,this.token)];case 2:return e.uploadUrl=a.sent(),this.uploadAt=(new Date).getTime(),[4,this.run()];case 3:return n=a.sent(),this.onComplete(n.data),this.config.disableStatisticsReport||this.sendLog(n.reqId,200),[2,n];case 4:if(r=a.sent(),this.clear(),r.isRequestError&&!this.config.disableStatisticsReport&&(o=this.aborted?"":r.reqId,i=this.aborted?-2:r.code,this.sendLog(o,i)),s=r.isRequestError&&0===r.code&&!this.aborted,u=++this.retryCount<=this.config.retryCount,s&&u||612===r.code)return[2,this.putFile()];throw this.onError(r),r;case 5:return[2]}var c}))}))},t.prototype.clear=function(){this.xhrList.forEach((function(t){return t.abort()})),this.xhrList=[]},t.prototype.stop=function(){this.clear(),this.aborted=!0},t.prototype.addXhr=function(t){this.xhrList.push(t)},t.prototype.sendLog=function(t,e){this.statisticsLogger.log({code:e,reqId:t,host:b(this.uploadUrl),remoteIp:"",port:g(this.uploadUrl),duration:((new Date).getTime()-this.uploadAt)/1e3,time:Math.floor(this.uploadAt/1e3),bytesSent:this.progress?this.progress.total.loaded:0,upType:"jssdk-h5",size:this.file.size},this.token)},t.prototype.getProgressInfoItem=function(t,e){return{loaded:t,size:e,percent:t/e*100}},t}(),M=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),F=function(){return F=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},F.apply(this,arguments)},X=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{a(r.next(t))}catch(e){i(e)}}function u(t){try{a(r.throw(t))}catch(e){i(e)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))},G=function(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(u){i=[6,u],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}};var B=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return M(e,t),e.prototype.run=function(){return X(this,void 0,void 0,(function(){var t,e,n,r=this;return G(this,(function(o){switch(o.label){case 0:if(!this.config.chunkSize||(i=this.config.chunkSize,!/^[1-9]\d*$/.test(String(i))))throw new Error("chunkSize must be a positive integer");if(this.config.chunkSize>1024)throw new Error("chunkSize maximum value is 1024");return[4,this.initBeforeUploadChunks()];case 1:return o.sent(),t=new k((function(t){return r.uploadChunk(t)}),this.config.concurrentRequestLimit),e=this.chunks.map((function(e,n){return t.enqueue({chunk:e,index:n})})),(n=Promise.all(e).then((function(){return r.mkFileReq()}))).then((function(){a(r.getLocalKey())}),(function(t){612!==t.code&&400!==t.code||a(r.getLocalKey())})),[2,n]}var i}))}))},e.prototype.uploadChunk=function(t){return X(this,void 0,void 0,(function(){var e,n,r,o,i,s,u,a,c,h=this;return G(this,(function(l){switch(l.label){case 0:return e=t.index,n=t.chunk,r=this.uploadedList[e],o=this.config.checkByMD5,i=function(){h.updateChunkProgress(n.size,e)},r&&!o?(i(),[2]):[4,f(n)];case 1:return s=l.sent(),r&&s===r.md5?(i(),[2]):(a={body:n,onProgress:u=function(t){h.updateChunkProgress(t.loaded,e)},onCreate:function(t){return h.addXhr(t)}},[4,U(this.token,this.key,t.index+1,this.getUploadInfo(),a)]);case 2:return c=l.sent(),u({loaded:n.size,total:n.size}),this.uploadedList[e]={etag:c.data.etag,md5:c.data.md5,size:n.size},function(t,e){try{localStorage.setItem(t,JSON.stringify(e))}catch(n){window.console&&window.console.warn}}(this.getLocalKey(),{id:this.uploadId,data:this.uploadedList}),[2]}}))}))},e.prototype.mkFileReq=function(){return X(this,void 0,void 0,(function(){var t,e,n=this;return G(this,(function(r){switch(r.label){case 0:return t=F(F(F({parts:this.uploadedList.map((function(t,e){return{etag:t.etag,partNumber:e+1}})),fname:this.putExtra.fname},this.putExtra.mimeType&&{mimeType:this.putExtra.mimeType}),this.putExtra.customVars&&{customVars:this.putExtra.customVars}),this.putExtra.metadata&&{metadata:this.putExtra.metadata}),[4,(o=this.token,i=this.key,s=this.getUploadInfo(),u={onCreate:function(t){return n.addXhr(t)},body:JSON.stringify(t)},y(I(m(o).bucket,i,s),q(q({},u),{method:"POST",headers:l(o)})))];case 1:return e=r.sent(),this.updateMkFileProgress(1),[2,e]}var o,i,s,u}))}))},e.prototype.initBeforeUploadChunks=function(){return X(this,void 0,void 0,(function(){var t,e;return G(this,(function(r){switch(r.label){case 0:return(t=function(t){try{var e=localStorage.getItem(t);return e?JSON.parse(e):null}catch(n){return window.console&&window.console.warn,null}}(this.getLocalKey()))?[3,2]:(a(this.getLocalKey()),[4,(o=this.token,i=this.bucket,s=this.key,h=this.uploadUrl,y(h+"/buckets/"+i+"/objects/"+(null!=s?n(s):"~")+"/uploads",{method:"POST",headers:c(o)}))]);case 1:return e=r.sent(),this.uploadId=e.data.uploadId,this.uploadedList=[],[3,3];case 2:this.uploadId=t.id,this.uploadedList=t.data,r.label=3;case 3:return this.chunks=function(t,e){var n=e*u;if(n>t.size)n=t.size;else for(;t.size>1e4*n;)n*=2;for(var r=[],o=Math.ceil(t.size/n),i=0;i<o;i++){var s=t.slice(n*i,i===o-1?t.size:n*(i+1));r.push(s)}return r}(this.file,this.config.chunkSize),this.loaded={mkFileProgress:0,chunks:this.chunks.map((function(t){return 0}))},this.notifyResumeProgress(),[2]}var o,i,s,h}))}))},e.prototype.getUploadInfo=function(){return{id:this.uploadId,url:this.uploadUrl}},e.prototype.getLocalKey=function(){return t=this.file.name,e=this.key,n=this.file.size,"qiniu_js_sdk_upload_file_name_"+t+(null==e?"_":"_key_"+e+"_")+"size_"+n;var t,e,n},e.prototype.updateChunkProgress=function(t,e){this.loaded.chunks[e]=t,this.notifyResumeProgress()},e.prototype.updateMkFileProgress=function(t){this.loaded.mkFileProgress=t,this.notifyResumeProgress()},e.prototype.notifyResumeProgress=function(){var t,e=this;this.progress={total:this.getProgressInfoItem((t=this.loaded.chunks,t.reduce((function(t,e){return t+e}),0)+this.loaded.mkFileProgress),this.file.size+1),chunks:this.chunks.map((function(t,n){return e.getProgressInfoItem(e.loaded.chunks[n],t.size)})),uploadInfo:{id:this.uploadId,url:this.uploadUrl}},this.onData(this.progress)},e}(D),V=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),H=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function s(t){try{a(r.next(t))}catch(e){i(e)}}function u(t){try{a(r.throw(t))}catch(e){i(e)}}function a(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,u)}a((r=r.apply(t,e||[])).next())}))},N=function(t,e){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(u){i=[6,u],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},J=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return V(e,t),e.prototype.run=function(){return H(this,void 0,void 0,(function(){var t,e,n,r=this;return N(this,(function(o){switch(o.label){case 0:return(t=new FormData).append("file",this.file),t.append("token",this.token),null!=this.key&&t.append("key",this.key),t.append("fname",this.putExtra.fname),this.putExtra.customVars&&(e=this.putExtra.customVars,Object.keys(e).forEach((function(n){return t.append(n,e[n].toString())}))),[4,y(this.uploadUrl,{method:"POST",body:t,onProgress:function(t){r.updateDirectProgress(t.loaded,t.total)},onCreate:function(t){return r.addXhr(t)}})];case 1:return n=o.sent(),this.finishDirectProgress(),[2,n]}}))}))},e.prototype.updateDirectProgress=function(t,e){this.progress={total:this.getProgressInfoItem(t,e+1)},this.onData(this.progress)},e.prototype.finishDirectProgress=function(){if(!this.progress)return this.progress={total:this.getProgressInfoItem(this.file.size,this.file.size)},void this.onData(this.progress);var t=this.progress.total;this.progress={total:this.getProgressInfoItem(t.loaded+1,t.size)},this.onData(this.progress)},e}(D);var K=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),W=function(){return W=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t},W.apply(this,arguments)},Q=function(t){function e(e,n,r){var o=t.call(this)||this;return o.isStopped=!1,o.destination=e&&"object"==typeof e?e:W(W(W({},e&&{next:e}),n&&{error:n}),r&&{complete:r}),o}return K(e,t),e.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,t.prototype.unsubscribe.call(this))},e.prototype.next=function(t){!this.isStopped&&this.destination.next&&this.destination.next(t)},e.prototype.error=function(t){!this.isStopped&&this.destination.error&&(this.isStopped=!0,this.destination.error(t))},e.prototype.complete=function(t){!this.isStopped&&this.destination.complete&&(this.isStopped=!0,this.destination.complete(t))},e}(function(){function t(){this.closed=!1}return t.prototype.unsubscribe=function(){this.closed||(this.closed=!0,this._unsubscribe&&this._unsubscribe())},t.prototype.add=function(t){this._unsubscribe=t},t}()),Y=function(){function t(t){this._subscribe=t}return t.prototype.subscribe=function(t,e,n){var r=new Q(t,e,n);return r.add(this._subscribe(r)),r},t}(),Z={PNG:"image/png",JPEG:"image/jpeg",WEBP:"image/webp",BMP:"image/bmp"};Object.keys(Z).map((function(t){return Z[t]}));var $=new w;function tt(t,e,n,r,o){var i={file:t,key:e,token:n,putExtra:r,config:o};return new Y((function(t){var e=function(t,e,n){return t.config&&t.config.forceDirect?new J(t,e,n):t.file.size>4*u?new B(t,e,n):new J(t,e,n)}(i,{onData:function(e){return t.next(e)},onError:function(e){return t.error(e)},onComplete:function(e){return t.complete(e)}},$);return e.putFile(),e.stop.bind(e)}))}export{tt as u};
