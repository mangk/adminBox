import"./XvueVe3_Elhr.js";import{B as e,R as a,A as l,y as t,S as o,T as i,U as s,c as r,M as n,V as d,j as u}from"./X@element-plusCerOoRDG.js";import{f as p,a as c,b as m,c as v,d as f,e as g,g as h,h as y,i as b,j as w}from"./XfileUploadiTSLYb7E.js";import"./XindexB3gMGtar.js";import{u as x}from"./Xqiniu-jsD3ZZPLL7.js";import{C as k}from"./Xcos-js-sdk-v5B2H1ItxU.js";import{E as j,a as _}from"./Xelement-plusCO1bik-q.js";import{e as X,f as S,al as z,o as C,H as T,I as V,Q as U,a as E,D as K,O as B,u as I,M as q,L as A}from"./X@vueCM7II4So.js";import"./XpiniaHbUHA5wR.js";import"./XaxiosDtE8dZ3W.js";import"./XmittCNZ6avp8.js";import"./Xvue-routerCYJBVSJE.js";import"./XnprogressCIdgZ774.js";import"./Xvue3-sfc-loaderDa78GGQm.js";import"./Xlodash-esBCrAzI1e.js";import"./X@vueuseDU8TvUvn.js";import"./X@popperjsD3lHDW-0.js";import"./X@ctrlD2oWfImC.js";import"./XdayjsBLCVIqfw.js";import"./Xasync-validatorCuo4gI4y.js";import"./Xmemoize-oneDs0C_khL.js";import"./Xnormalize-wheel-esVn5vHDCm.js";import"./X@floating-uipMauM7H8.js";import"./Xspark-md5D6_etk78.js";import"./Xexif-jsCAaicHrt.js";const L={style:{position:"absolute",bottom:"5px",left:"10px"}},N={style:{display:"flex"}},P={class:"el-upload__text",style:{height:"30px","line-height":"30px","text-align":"center",overflow:"hidden",display:"flex","flex-flow":"row nowrap","justify-content":"center"}},R=E("em",null,"点击选择文件",-1),M={class:"el-upload__tip"},O={__name:"baseManager",props:{modelValue:{type:Array,default:()=>[]},selectKey:{type:String,default:"id"}},emits:["update:modelValue"],setup(O,{emit:D}){const J=O,$=X(null);S((()=>J.modelValue),((e,a)=>{0===e.length&&$.value.clearSelection()}));const H=D,Q=X({});p().then((e=>{Q.value=e.data}));const W=X([]),F=()=>{c().then((e=>{const a=Array.isArray(e.data)?e.data:[];W.value=a}))};F();const G=X(""),Y=X(!1),Z=X();X(0);const ee=X([]),ae=X(1),le=X(20),te=X(0),oe=X(0),ie=X(""),se=X(""),re=X([]),ne=X([]),de=(e=!1)=>{e&&(ae.value=1,le.value=20);let a={};oe.value&&(a.group_id=oe.value),ie.value&&(a.name=ie.value),se.value&&(a.tag=se.value),m(ae.value,le.value,a).then((e=>{re.value=e.data.list,ae.value=e.data.page,le.value=e.data.page_size,te.value=e.data.total}))},ue=()=>{G.value?v(G.value,oe.value).then((e=>{F(),G.value=""})):j.warning("请输入分组名称")},pe=()=>{oe.value?f(oe.value).then((e=>{F()})):j.warning("请选择分组")},ce=async e=>{let a=await g(e.file.name);switch(a.data.driver){case"cos":let l=JSON.parse(a.data.token);const{Credentials:t={},StartTime:o,ExpiredTime:i,bucket:s,region:r,key:n}=l;new k({SecretId:t.TmpSecretId,SecretKey:t.TmpSecretKey,SecurityToken:t.Token,StartTime:o,ExpiredTime:i}).putObject({Bucket:s,Region:r,Key:n,Body:e.file,onProgress:a=>{e.onProgress(a.percent)}},((a,l)=>{a?e.onError(error):(e.onSuccess(l),l.driver="cos",h({path:l.Location,driver:"cos",group:oe.value?oe.value:0,key:n})),setTimeout((()=>{oe.value=0,de(!0)}),1500)}));break;case"qiniu":x(e.file,a.data.key,a.data.token).subscribe((a=>{e.onProgress(a.total)}),(a=>{e.onError(a),setTimeout((()=>{oe.value=0,de(!0)}),1500)}),(a=>{h({path:a.cdn+a.key,driver:"qiniu",group:oe.value?oe.value:0,key:a.key}),e.onSuccess(a),setTimeout((()=>{oe.value=0,de(!0)}),1500)}))}},me=()=>{Z.value.submit()},ve=(e,a)=>{a.findIndex((a=>a.name==e.name))!=a.findLastIndex((a=>a.name==e.name))&&(j.info(e.name+" 已存在于列表中"),a.pop()),ee.value=a},fe=e=>{ne.value=e.map((e=>e[J.selectKey])),H("update:modelValue",ne.value)},ge=e=>{le.value=e,de()},he=e=>{ae.value=e,de()},ye=e=>{e.id?oe.value=e.id:oe.value="",de(!0)},be=e=>{y(ne.value,e.id).then((e=>{0!=e.code?j.error(e.msg):j.success("移动成功"),de()}))},we=async e=>{switch(e){case"clearSelected":$.value.clearSelection();break;case"downlaod":re.value.forEach((async e=>{if(ne.value.includes(e.id)){const a=document.createElement("iframe");a.style.display="none",a.src=e.url+"?attname=",document.body.appendChild(a),setTimeout((()=>{document.body.removeChild(a)}),5e3)}}));break;case"copyUrl":try{let e="";re.value.forEach((a=>{ne.value.includes(a.id)&&(e+=a.url+"\n")})),await navigator.clipboard.writeText(e),j({message:"已复制",type:"success"})}catch(a){j({message:"未授权读取剪贴板",type:"error"})}break;case"delete":_.confirm("删除后文件无法找回！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{b(ne.value).then((e=>{0==e.code&&j({message:"已删除",type:"success"}),de()}))}))}},xe=(e,a,l,t)=>{w({from:e.data.id,to:a.data.id,type:l}).then((e=>{proxy.$message.success("移动完成")}))};return de(),(p,c)=>{const m=z("el-tree"),v=z("el-button"),f=z("el-input"),g=z("el-popover"),h=z("el-col"),y=z("el-dropdown-item"),b=z("el-dropdown-menu"),w=z("el-dropdown"),x=z("upload-filled"),k=z("el-icon"),j=z("el-upload"),_=z("el-row"),X=z("el-table-column"),S=z("el-image"),D=z("el-table"),J=z("el-pagination");return C(),T(_,{gutter:20,style:{width:"100%",height:"100%","box-sizing":"border-box"}},{default:V((()=>[U(h,{span:4,style:{position:"relative",height:"100%"}},{default:V((()=>[U(m,{class:"file-tree-box",data:W.value,props:{label:"name",children:"children"},onNodeClick:ye,onNodeDrop:xe,"default-expand-all":"","expand-on-click-node":!1,draggable:""},{default:V((({node:e,data:a})=>[E("div",{class:K(a.id==oe.value?"self-node node-active":"self-node")},B(e.label),3)])),_:1},8,["data"]),E("div",L,[U(g,{placement:"top-start",width:260,trigger:"hover"},{reference:V((()=>[U(v,{icon:I(e),size:"small",style:{"border-right":"0px"},link:""},null,8,["icon"])])),default:V((()=>[U(f,{modelValue:G.value,"onUpdate:modelValue":c[0]||(c[0]=e=>G.value=e),style:{width:"200px"},size:"small",placeholder:"输入分组名称"},null,8,["modelValue"]),U(v,{icon:I(a),type:"success",style:{"margin-left":"10px"},onClick:ue,link:""},null,8,["icon"])])),_:1}),U(v,{icon:I(l),size:"small",onClick:pe,link:""},null,8,["icon"])])])),_:1}),U(h,{span:20,style:{position:"relative",height:"100%","background-color":"#fff","box-sizing":"border-box",padding:"10px"}},{default:V((()=>[U(_,{style:{display:"flex","justify-content":"space-between"}},{default:V((()=>[E("div",N,[U(v,{icon:I(t),onClick:c[1]||(c[1]=e=>de(!0)),style:{"margin-right":"10px"}},null,8,["icon"]),U(w,{disabled:!ne.value.length,style:{"margin-right":"10px"},onCommand:we},{dropdown:V((()=>[U(b,null,{default:V((()=>[U(y,{command:"clearSelected"},{default:V((()=>[q("清空已选")])),_:1}),U(y,{command:"downlaod",icon:I(o)},{default:V((()=>[q("下载文件")])),_:1},8,["icon"]),U(y,{command:"copyUrl",icon:I(i)},{default:V((()=>[q("复制链接")])),_:1},8,["icon"]),U(y,{command:"move",icon:I(s)},{default:V((()=>[U(g,{placement:"right",width:300,trigger:"hover"},{reference:V((()=>[q(" 移动到 ")])),default:V((()=>[U(m,{data:W.value,props:{label:"name",children:"children"},onNodeClick:be,"default-expand-all":"","expand-on-click-node":!1,draggable:""},{default:V((({node:e,data:a})=>[q(B(e.label),1)])),_:1},8,["data"])])),_:1})])),_:1},8,["icon"]),U(y,{command:"delete",icon:I(r),divided:""},{default:V((()=>[q("删除")])),_:1},8,["icon"])])),_:1})])),default:V((()=>[U(v,{disabled:!ne.value.length},{default:V((()=>[q(" 批量操作"+B(ne.value.length?"("+ne.value.length+")":""),1)])),_:1},8,["disabled"])])),_:1},8,["disabled"]),U(f,{modelValue:ie.value,"onUpdate:modelValue":c[3]||(c[3]=e=>ie.value=e),style:{"max-width":"450px","min-width":"100px"},placeholder:"搜索文件名",clearable:"",class:"input-with-select",onClear:c[4]||(c[4]=e=>de(!0))},{append:V((()=>[U(v,{icon:I(n),onClick:c[2]||(c[2]=e=>de(!0))},null,8,["icon"])])),_:1},8,["modelValue"])]),U(g,{placement:"bottom-start",width:400,height:200,visible:Y.value},{reference:V((()=>[U(v,{type:Y.value?"danger":"primary",icon:Y.value?I(r):I(d),onClick:c[5]||(c[5]=e=>Y.value=!Y.value)},{default:V((()=>[q(B(Y.value?"关闭窗口":"上传文件"),1)])),_:1},8,["type","icon"])])),default:V((()=>[U(j,{class:"upload-demo",drag:"","auto-upload":!1,ref_key:"fileUploadRef",ref:Z,"http-request":ce,"file-list":ee.value,"onUpdate:fileList":c[6]||(c[6]=e=>ee.value=e),"on-change":ve,multiple:""},{trigger:V((()=>[E("div",P,[U(k,{class:"el-icon--upload",style:{"font-size":"25px",margin:"0px var(--global-padding) 0 0"}},{default:V((()=>[U(x)])),_:1}),q(" 将文件拖到此处或"),R])])),tip:V((()=>[E("div",M,[ee.value.length?(C(),T(v,{key:0,type:"success",size:"small",icon:I(u),onClick:me},{default:V((()=>[q(" 开始上传 ")])),_:1},8,["icon"])):A("",!0)])])),_:1},8,["file-list"])])),_:1},8,["visible"])])),_:1}),U(D,{ref_key:"tableRef",ref:$,data:re.value,"row-key":e=>e[O.selectKey],"highlight-current-row":"","show-overflow-tooltip":"",stripe:"",width:"100%",border:"",style:{"margin-top":"9px","border-top":"1px solid var(--el-table-border-color)",overflow:"auto",height:"calc(100% - 80px)"},onSelectionChange:fe},{default:V((()=>[U(X,{type:"selection","reserve-selection":!0,width:"55",fixed:""}),U(X,{prop:"name",label:"文件名",width:"350",fixed:""}),U(X,{prop:"url",label:"预览",width:"80"},{default:V((e=>{return[(a=e.row.url,/\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(a)?(C(),T(S,{key:0,style:{width:"50px",height:"50px"},src:e.row.url.startsWith("http")?e.row.url:"//"+e.row.url,lazy:"",fit:"scale-down"},null,8,["src"])):A("",!0))];var a})),_:1}),U(X,{prop:"url",label:"链接",width:"80"}),U(X,{prop:"tag",label:"类型",width:"80"}),U(X,{prop:"group_info.name",label:"分组"}),U(X,{prop:"ct",label:"创建时间",width:"160"})])),_:1},8,["data","row-key"]),U(J,{"current-page":ae.value,"onUpdate:currentPage":c[7]||(c[7]=e=>ae.value=e),"page-size":le.value,"onUpdate:pageSize":c[8]||(c[8]=e=>le.value=e),"page-sizes":[20,50,100,200],size:"small",layout:"total, sizes, prev, pager, next, jumper",total:te.value,onSizeChange:ge,onCurrentChange:he},null,8,["current-page","page-size","total"])])),_:1})])),_:1})}}};export{O as default};
