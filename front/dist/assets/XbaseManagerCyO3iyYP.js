import"./XvueDq6FxnTE.js";import{B as e,R as a,A as l,c as t,S as o,o as i,T as s,U as n,V as r,M as d}from"./X@element-plusB5GzQf1a.js";import{f as u,a as c,b as p,c as m,d as v,e as f,g,h,i as y}from"./XfileUploadCHvob2Yb.js";import"./XindexLHjoYxDb.js";import{u as b}from"./Xqiniu-jsD3ZZPLL7.js";import{C as x}from"./Xcos-js-sdk-v5B2H1ItxU.js";import{E as w,a as j}from"./Xelement-plusCBLTFLBf.js";import{b as k,e as _,ah as X,o as S,P as z,Q as C,X as T,a as V,K as U,W as E,u as K,V as B,U as P}from"./X@vueDkxIAGiu.js";import"./XpiniaCIH0lQhM.js";import"./XaxiosDtE8dZ3W.js";import"./XmittCNZ6avp8.js";import"./Xvue-routerCciq6Mc4.js";import"./XnprogressCIdgZ774.js";import"./Xvue3-sfc-loaderDa78GGQm.js";import"./Xlodash-esBg5u8xPa.js";import"./X@vueuse4nPxBlH-.js";import"./X@popperjsD3lHDW-0.js";import"./X@ctrlD2oWfImC.js";import"./XdayjsBsZV2HIa.js";import"./Xasync-validatorCuo4gI4y.js";import"./Xmemoize-oneDs0C_khL.js";import"./Xnormalize-wheel-esVn5vHDCm.js";import"./X@floating-uipMauM7H8.js";import"./Xspark-md5D6_etk78.js";import"./Xexif-jsCAaicHrt.js";const A={style:{position:"absolute",bottom:"5px",left:"10px"}},I={class:"el-upload__text",style:{height:"30px","line-height":"30px","text-align":"center",overflow:"hidden",display:"flex","flex-flow":"row nowrap","justify-content":"center"}},R=V("em",null,"点击选择文件",-1),q={class:"el-upload__tip"},L={__name:"baseManager",props:{modelValue:{type:Array,default:()=>[]},selectKey:{type:String,default:"id"}},emits:["update:modelValue"],setup(L,{emit:N}){const J=L,M=k(null);_((()=>J.modelValue),((e,a)=>{0===e.length&&M.value.clearSelection()}));const O=N,Q=k({});u().then((e=>{Q.value=e.data}));const W=k([]),D=()=>{c().then((e=>{const a=Array.isArray(e.data)?e.data:[];W.value=a}))};D();const F=k(""),G=k(!1),H=k();k(0);const Y=k([]),Z=k(1),$=k(20),ee=k(0),ae=k(0),le=k(""),te=k(""),oe=k([]),ie=k([]),se=(e=!1)=>{e&&(Z.value=1,$.value=20);let a={};ae.value&&(a.group_id=ae.value),le.value&&(a.name=le.value),te.value&&(a.tag=te.value),p(Z.value,$.value,a).then((e=>{oe.value=e.data.list,Z.value=e.data.page,$.value=e.data.page_size,ee.value=e.data.total}))},ne=()=>{F.value?m(F.value,ae.value).then((e=>{D(),F.value=""})):w.warning("请输入分组名称")},re=()=>{ae.value?v(ae.value).then((e=>{D()})):w.warning("请选择分组")},de=async e=>{let a=await f(e.file.name);switch(a.data.driver){case"cos":let l=JSON.parse(a.data.token);const{Credentials:t={},StartTime:o,ExpiredTime:i,bucket:s,region:n,key:r}=l;new x({SecretId:t.TmpSecretId,SecretKey:t.TmpSecretKey,SecurityToken:t.Token,StartTime:o,ExpiredTime:i}).putObject({Bucket:s,Region:n,Key:r,Body:e.file,onProgress:a=>{e.onProgress(a.percent)}},((a,l)=>{a?e.onError(error):(e.onSuccess(l),l.driver="cos",g({path:l.Location,driver:"cos",group:ae.value?ae.value:0,key:r})),setTimeout((()=>{ae.value=0,se(!0)}),1500)}));break;case"qiniu":b(e.file,a.data.key,a.data.token).subscribe((a=>{e.onProgress(a.total)}),(a=>{e.onError(a),setTimeout((()=>{ae.value=0,se(!0)}),1500)}),(a=>{e.onSuccess(a),setTimeout((()=>{ae.value=0,se(!0)}),1500)}))}},ue=()=>{H.value.submit()},ce=(e,a)=>{a.findIndex((a=>a.name==e.name))!=a.findLastIndex((a=>a.name==e.name))&&(w.info(e.name+" 已存在于列表中"),a.pop()),Y.value=a},pe=e=>{ie.value=e.map((e=>e[J.selectKey])),O("update:modelValue",ie.value)},me=e=>{$.value=e,se()},ve=e=>{Z.value=e,se()},fe=e=>{e.id?ae.value=e.id:ae.value="",se(!0)},ge=e=>{h(ie.value,e.id).then((e=>{0!=e.code?w.error(e.msg):w.success("移动成功"),se()}))},he=async e=>{switch(e){case"clearSelected":M.value.clearSelection();break;case"downlaod":oe.value.forEach((async e=>{if(ie.value.includes(e.id)){const a=document.createElement("iframe");a.style.display="none",a.src=e.url+"?attname=",document.body.appendChild(a),setTimeout((()=>{document.body.removeChild(a)}),5e3)}}));break;case"copyUrl":try{let e="";oe.value.forEach((a=>{ie.value.includes(a.id)&&(e+=a.url+"\n")})),await navigator.clipboard.writeText(e),w({message:"已复制",type:"success"})}catch(a){w({message:"未授权读取剪贴板",type:"error"})}break;case"delete":j.confirm("删除后文件无法找回！","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{y(ie.value).then((e=>{0==e.code&&w({message:"已删除",type:"success"}),se()}))}))}};return se(),(u,c)=>{const p=X("el-tree"),m=X("el-button"),v=X("el-input"),f=X("el-popover"),g=X("el-col"),h=X("upload-filled"),y=X("el-icon"),b=X("el-upload"),x=X("el-dropdown-item"),w=X("el-dropdown-menu"),j=X("el-dropdown"),k=X("el-row"),_=X("el-table-column"),N=X("el-table"),J=X("el-pagination");return S(),z(k,{gutter:20,style:{width:"100%",height:"100%","box-sizing":"border-box"}},{default:C((()=>[T(g,{span:4,style:{position:"relative",height:"100%"}},{default:C((()=>[T(p,{class:"file-tree-box",data:W.value,props:{label:"name",children:"children"},onNodeClick:fe,"default-expand-all":"","expand-on-click-node":!1,draggable:""},{default:C((({node:e,data:a})=>[V("div",{class:U(a.id==ae.value?"self-node node-active":"self-node")},E(e.label),3)])),_:1},8,["data"]),V("div",A,[T(f,{placement:"top-start",width:260,trigger:"hover"},{reference:C((()=>[T(m,{icon:K(e),size:"small",style:{"border-right":"0px"},link:""},null,8,["icon"])])),default:C((()=>[T(v,{modelValue:F.value,"onUpdate:modelValue":c[0]||(c[0]=e=>F.value=e),style:{width:"200px"},size:"small",placeholder:"输入分组名称"},null,8,["modelValue"]),T(m,{icon:K(a),type:"success",style:{"margin-left":"10px"},onClick:ne,link:""},null,8,["icon"])])),_:1}),T(m,{icon:K(l),size:"small",onClick:re,link:""},null,8,["icon"])])])),_:1}),T(g,{span:20,style:{position:"relative",height:"100%","background-color":"#fff","box-sizing":"border-box",padding:"10px"}},{default:C((()=>[T(k,{style:{display:"flex","justify-content":"space-between"}},{default:C((()=>[V("div",null,[T(f,{placement:"bottom-start",width:400,visible:G.value},{reference:C((()=>[T(m,{type:G.value?"danger":"primary",icon:G.value?K(t):K(o),onClick:c[1]||(c[1]=e=>G.value=!G.value)},{default:C((()=>[B(E(G.value?"关闭窗口":"上传文件"),1)])),_:1},8,["type","icon"])])),default:C((()=>[T(b,{class:"upload-demo",drag:"","auto-upload":!1,ref_key:"fileUploadRef",ref:H,"http-request":de,"file-list":Y.value,"onUpdate:fileList":c[2]||(c[2]=e=>Y.value=e),"on-change":ce,multiple:""},{trigger:C((()=>[V("div",I,[T(y,{class:"el-icon--upload",style:{"font-size":"25px",margin:"0px var(--global-padding) 0 0"}},{default:C((()=>[T(h)])),_:1}),B(" 将文件拖到此处或"),R])])),tip:C((()=>[V("div",q,[Y.value.length?(S(),z(m,{key:0,type:"success",size:"small",icon:K(i),onClick:ue},{default:C((()=>[B(" 开始上传 ")])),_:1},8,["icon"])):P("",!0)])])),_:1},8,["file-list"])])),_:1},8,["visible"]),T(j,{disabled:!ie.value.length,style:{"margin-left":"10px"},onCommand:he},{dropdown:C((()=>[T(w,null,{default:C((()=>[T(x,{command:"clearSelected"},{default:C((()=>[B("清空已选")])),_:1}),T(x,{command:"downlaod",icon:K(s)},{default:C((()=>[B("下载文件")])),_:1},8,["icon"]),T(x,{command:"copyUrl",icon:K(n)},{default:C((()=>[B("复制链接")])),_:1},8,["icon"]),T(x,{command:"move",icon:K(r)},{default:C((()=>[T(f,{placement:"right",width:300,trigger:"hover"},{reference:C((()=>[B(" 移动到 ")])),default:C((()=>[T(p,{data:W.value,props:{label:"name",children:"children"},onNodeClick:ge,"default-expand-all":"","expand-on-click-node":!1,draggable:""},{default:C((({node:e,data:a})=>[B(E(e.label),1)])),_:1},8,["data"])])),_:1})])),_:1},8,["icon"]),T(x,{command:"delete",icon:K(t),divided:""},{default:C((()=>[B("删除")])),_:1},8,["icon"])])),_:1})])),default:C((()=>[T(m,{disabled:!ie.value.length},{default:C((()=>[B(" 批量操作"+E(ie.value.length?"("+ie.value.length+")":""),1)])),_:1},8,["disabled"])])),_:1},8,["disabled"])]),T(v,{modelValue:le.value,"onUpdate:modelValue":c[4]||(c[4]=e=>le.value=e),style:{"max-width":"450px",width:"30%"},placeholder:"搜索文件名",clearable:"",class:"input-with-select",onClear:c[5]||(c[5]=e=>se(!0))},{append:C((()=>[T(m,{icon:K(d),onClick:c[3]||(c[3]=e=>se(!0))},null,8,["icon"])])),_:1},8,["modelValue"])])),_:1}),T(N,{ref_key:"tableRef",ref:M,data:oe.value,"row-key":e=>e[L.selectKey],"highlight-current-row":"","show-overflow-tooltip":"",stripe:"",width:"100%",border:"",style:{"margin-top":"9px","border-top":"1px solid var(--el-table-border-color)",overflow:"auto",height:"calc(100% - 80px)"},onSelectionChange:pe},{default:C((()=>[T(_,{type:"selection","reserve-selection":!0,width:"55",fixed:""}),T(_,{prop:"name",label:"文件名",width:"400"}),T(_,{prop:"url",label:"链接",width:"80"}),T(_,{prop:"tag",label:"类型",width:"80"}),T(_,{prop:"group_info.name",label:"分组"}),T(_,{prop:"ct",label:"创建时间",width:"160"})])),_:1},8,["data","row-key"]),T(J,{"current-page":Z.value,"onUpdate:currentPage":c[6]||(c[6]=e=>Z.value=e),"page-size":$.value,"onUpdate:pageSize":c[7]||(c[7]=e=>$.value=e),"page-sizes":[20,50,100,200],size:"small",layout:"total, sizes, prev, pager, next, jumper",total:ee.value,onSizeChange:me,onCurrentChange:ve},null,8,["current-page","page-size","total"])])),_:1})])),_:1})}}};export{L as default};
